---
# tasks file for set_kea_reservations
# wipe stack reservations once (for this and the next play enough)
- name: wipe kea reservations
  delegate_to: localhost
  run_once: true
  alchemy_delete:
    pg_conn_str: "{{ pg_conn_str }}"
    table: kea_reservations
    where:
      stack_fqdn: "{{ stack_name }}.{{ pve_cloud_domain }}"

- name: insert kea reservations
  delegate_to: localhost
  alchemy_write:
    pg_conn_str: "{{ pg_conn_str }}"
    table: kea_reservations
    rows:
      - ip: "{{ ansible_facts['pve'].ipv4.address }}"
        mac: "{{ ansible_facts['pve'].macaddress }}"
        hostname: "{{ ansible_fqdn }}"
        stack_fqdn: "{{ stack_name }}.{{ pve_cloud_domain }}"
        machine_type: "{{ cloud_machine_type }}"
  # reservations only happen for k8s nodes / or lxc/vms that define tcp proxies
  # todo: add reservation cleanup to qemu / lxc delete playbooks
  when: cloud_machine_type.startswith('k8s_') or tcp_proxies is defined
