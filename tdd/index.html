
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../terraform/">
      
      
        <link rel="next" href="../faq/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Test Driven Development - PVE Cloud Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/mkdocs_puml/puml.css">
    
      <link rel="stylesheet" href="../assets/mkdocs_puml/interaction.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#test-driven-development" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PVE Cloud Documentation" class="md-header__button md-logo" aria-label="PVE Cloud Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PVE Cloud Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Test Driven Development
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PVE Cloud Documentation" class="md-nav__button md-logo" aria-label="PVE Cloud Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    PVE Cloud Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    General
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bootstrap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup/Bootstrap
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kubespray K8S
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../terraform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terraform
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Test Driven Development
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Test Driven Development
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#avahi-mdns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Avahi mdns
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#e2e-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        E2E Architecture
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubeconfig-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubeconfig access
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vscode-pytest-debug" class="md-nav__link">
    <span class="md-ellipsis">
      
        VSCode Pytest debug
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VSCode Pytest debug">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-root-projects" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-Root Projects
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Schemas
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Schemas
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/kubespray_inv_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kubespray inv schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/lxc_inv_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lxc inv schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/pve_cloud_inv_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pve cloud inv schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/qemu_inv_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Qemu inv schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/qemu_schema_base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Qemu schema base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/setup_bind_schema_ext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup bind schema ext
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/setup_ceph_kea_schema_ext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup ceph kea schema ext
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/setup_haproxy_schema_ext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup haproxy schema ext
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/setup_kea_schema_ext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup kea schema ext
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/vm_schema_base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vm schema base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="test-driven-development">Test Driven Development</h1>
<p>For development you will need a dedicated proxmox cluster (a small one will suffice), and another dedicated vlan. The testing suite deploys and configures a proxmox cloud with locally build artifacts.</p>
<h2 id="avahi-mdns">Avahi mdns</h2>
<p>Make you test proxmox cluster also discoverable via avahi as described in the <a href="../bootstrap/">bootstrap section</a> and setup reflector/repeaters as required.</p>
<h2 id="e2e-architecture">E2E Architecture</h2>
<p>Pytest is our core testing framework, in combination with ansible_runner and the terraform cli we build and test the entire collection end to end.</p>
<p>Our pytest fixtures contain the core setup of the cloud. And from them branch out one or more tests at every level. The fixtures are called only once (pytest session scope).</p>
<p><img alt="Arch" src="../e2e-arch.svg" /></p>
<p>Target run pytests against for example test_bind to restrict fixture execution.</p>
<h2 id="development">Development</h2>
<ul>
<li>add this to your <code>~/.ssh/config</code>, ssh validation can get annoying when often recreating containers and vms.</li>
</ul>
<pre><code>Host *
    StrictHostKeyChecking no
    UserKnownHostsFile /dev/null
</code></pre>
<ul>
<li>configure your docker <code>/etc/docker/daemon.json</code> to accept the local registry for insecure http pushes, followed by <code>sudo service docker restart</code></li>
</ul>
<pre><code class="language-json">{
  &quot;insecure-registries&quot;:  [&quot;192.168.1.0/24&quot;]
}
</code></pre>
<ul>
<li>install <code>direnv</code> and activate it in your local profile (add <code>eval "$(direnv hook bash)"</code> to .bashrc)</li>
<li>create a <code>pve-cloud</code> folder and checkout all the repositories you want to make changes to, if you checkout the ansible collections they have to be under <code>ansible_collections/pve/</code></li>
<li>create a dedicated venv for pve cloud development <code>python3 -m venv ~/.pve-cloud-dev-venv</code> and activate <code>source ~/.pve-cloud-dev-venv/bin/activate</code>, install the default ansible dependency from the bootstrap section</li>
<li>create a test environment config yaml (you can find the schema definition in the src folder of the <a href="https://github.com/Proxmox-Cloud/pytest-pve-cloud">pytest-pve-cloud repository</a>) - forward to the test domain your main dns (you can use <code>bind_forward_zones</code> in the pve cloud inventory if your main infrastructure already is a pve cloud)</li>
<li>create a <code>.envrc</code> file with env variables stored for development</li>
</ul>
<pre><code class="language-bash">export TDDOG_LOCAL_IFACE= # iface name of you local net ip `ip -4 addr show`. The deployed infrastructure needs your developer machines ip for pulling.
export PVE_CLOUD_TEST_CONF=$(pwd)/test-env-conf.yaml
export ANSIBLE_COLLECTIONS_PATH=$(pwd)
</code></pre>
<p>the created local dir might look like this:</p>
<pre><code>ansible_collections/pve/
  cloud
py-pve-cloud
pve-cloud-controller
.envrc
test-env-conf.yaml
</code></pre>
<ol>
<li>install build essentails <code>sudo apt install build-essential python3-dev</code> (or your distros equivalent)</li>
<li>install ansible as described in the <a href="../bootstrap/">bootstrap section</a> and also run the control node setup</li>
<li>launch local registries for watchdog rebuilds and fast deployment</li>
</ol>
<pre><code class="language-bash">docker run -d -p 5000:5000 --name pxc-local-registry registry:3 # local docker registry
docker run -d -p 8088:8080 --name pxc-local-pypi pypiserver/pypiserver:latest run -P . -a . # local pypi registry without auth
docker run -d --name pxc-local-redis -p 6379:6379 redis:latest # redis broker for triggering dependent builds
</code></pre>
<ol>
<li>run <code>tddog --recursive</code> from your top level created <code>pve-cloud</code> folder. This will monitor src folders, rebuild artifacts and their dependants and also run <code>pip install -e .</code> on libraries that are needed locally.</li>
<li>run the e2e tests:</li>
</ol>
<pre><code class="language-bash">pytest -s tests/e2e/ --skip-cleanup 

# you can also target specific steps
pytest -s tests/e2e/test_cloud.py::test_bind --skip-cleanup
</code></pre>
<p>If you want to develop the terraform provider you need golang installed.</p>
<h3 id="kubeconfig-access">Kubeconfig access</h3>
<p>If you passed <code>--skip-cleanup</code> to pytest, the kubespray tests will write a <code>.test-kubeconfig.yaml</code> file you can use for lens access to the testing cluster.</p>
<h2 id="vscode-pytest-debug">VSCode Pytest debug</h2>
<p>if you want to attach a debugger to the tests you can use the vscode python debug extension.</p>
<p>create a <code>.testenv</code> file with the same variables as the <code>.envrc</code> alongside it in your pve-cloud folder</p>
<p>the settings.json for vscode python debug should look something like this:</p>
<pre><code class="language-json">{
  &quot;python.testing.pytestArgs&quot;: [
    &quot;-s&quot;,
    &quot;tests/e2e&quot;,
    &quot;--skip-cleanup&quot;
  ],
  &quot;python.testing.unittestEnabled&quot;: false,
  &quot;python.testing.pytestEnabled&quot;: true,
  &quot;python.testing.cwd&quot;: &quot;${workspaceFolder}&quot;,
  &quot;python.envFile&quot;: &quot;${env:HOME}/pve-cloud/.testenv&quot;, // adjust it to the path
  &quot;python.defaultInterpreterPath&quot;: &quot;${env:HOME}/.pve-cloud-dev-venv/bin/python&quot;
}
</code></pre>
<p>Also select your python interpreter to the dev environment bin/python in the vscode command palette.</p>
<h3 id="multi-root-projects">Multi-Root Projects</h3>
<p>If you want to develop with multiple pve-cloud repositories at the same time you can create a <code>pve-cloud.code-workspace</code> file top folder.</p>
<p>Open this file via vscode File/Open Workspace from File...</p>
<pre><code class="language-json">{
  &quot;folders&quot;: [
    { &quot;path&quot;: &quot;.&quot;},
    { &quot;path&quot;: &quot;ansible_collections/pxc/cloud&quot; },
    { &quot;path&quot;: &quot;pve-cloud-tf&quot; }
  ],
  &quot;settings&quot;: {
    &quot;python.defaultInterpreterPath&quot;: &quot;${env:HOME}/.pve-cloud-dev-venv/bin/python&quot;
  }
}
</code></pre>
<p>This loads the e2e tests from both projects via their settings.json file.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["toc.follow", "toc.integrate", "search.suggest", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../assets/mkdocs_puml/puml.js"></script>
      
        <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
      
        <script src="../assets/mkdocs_puml/interaction.js"></script>
      
    
  </body>
</html>