
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../bootstrap/">
      
      
        <link rel="next" href="../terraform/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>Kubespray K8S - PVE Cloud Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2a3383ac.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kubespray-k8s" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PVE Cloud Documentation" class="md-header__button md-logo" aria-label="PVE Cloud Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PVE Cloud Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Kubespray K8S
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PVE Cloud Documentation" class="md-nav__button md-logo" aria-label="PVE Cloud Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    PVE Cloud Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    General
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bootstrap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup/Bootstrap
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Kubespray K8S
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Kubespray K8S
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deploying-a-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying a cluster
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ceph-csi" class="md-nav__link">
    <span class="md-ellipsis">
      Ceph CSI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tls-acme-certificates" class="md-nav__link">
    <span class="md-ellipsis">
      TLS ACME Certificates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TLS ACME Certificates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dns-provider-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      DNS Provider Secrets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrading-a-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      Upgrading a cluster
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#custom-kubespray-vars" class="md-nav__link">
    <span class="md-ellipsis">
      Custom kubespray vars
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exposing-k8s-controlplane-api" class="md-nav__link">
    <span class="md-ellipsis">
      Exposing K8S Controlplane API
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../terraform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Terraform
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tdd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Test Driven Development
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Miscellaneous
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Schemas
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Schemas
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/kubespray_inv_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    K8s Kubespray Inventory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/lxc_inv_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LXC Inventory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/pve_cloud_inv_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cloud Inventory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/qemu_inv_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VM Inventory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/setup_bind_schema_ext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bind Dns Inventory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/setup_ceph_kea_schema_ext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ceph DHCP Inventory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/setup_haproxy_schema_ext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HAProxy Inventory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/setup_kea_schema_ext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    General DHCP Inventory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/vm_schema_base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VM Base Schema
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="kubespray-k8s">Kubespray K8S</h1>
<p>The collection contains and integrates with the official kubespray collection.</p>
<p>It is recommended to create a seperate repository per kubernetes cluster, or aleast put the cluster inventory file into a seperate folder.</p>
<p>Checkout the <code>kubespray-cluster</code> dir in the <a href="https://github.com/Proxmox-Cloud/pve_cloud/tree/master/samples">samples directory</a> for a quick idea on how to setup!</p>
<h2 id="deploying-a-cluster">Deploying a cluster</h2>
<p>Again create custom inventory yaml file following this <a href="../schemas/kubespray_inv_schema/">k8s cluster schema</a>.</p>
<p>Afterwards run the <code>pve.cloud.sync_kubespray</code> playbook, this will fully create VMs, setup kubespray, initialize TLS Certificates and deploy core kubernetes helm charts (Ceph CSI, Ingress).</p>
<p>To get kubeconf after creation of the cluster for cli/ide access (expiring) use:</p>
<p><code>pvcli print-kubeconfig --inventory YOUR-KUBESPRAY-INV.yaml</code></p>
<h2 id="ceph-csi">Ceph CSI</h2>
<p>If you have ceph installed and configured in your proxmox cluster, and you define <code>ceph_csi_sc_pools</code> in your kubespray inventory, the ceph csi volume driver will be automatically configured and installed.</p>
<p>If you want to use ceph your kubernetes nodes need to have access to the ceph monitors, if your ceph is on a seperate network you can deploy a seperate kea dhcp for dynamically assinging ips to the nodes ceph network interfaces. For that you need a single lxc and the <code>setup_ceph_kea</code> playbook.</p>
<h2 id="tls-acme-certificates">TLS ACME Certificates</h2>
<p>This collection doesn't use kubernetes certmanager for TLS certificates, but instead comes with an external centralised solution. </p>
<p>Initially certificates are generated via ansible roles, integrated into the collection. The update process afterwards is handled via <a href="https://github.com/Proxmox-Cloud/pve-cloud-awx-cron">AWX cron jobs</a>. Use the awx helm chart via terraform to deploy your own instance.</p>
<h3 id="dns-provider-secrets">DNS Provider Secrets</h3>
<p>At the moment the collection supports ionos and aws route53 for dynamically solving dns01 challenges and obtaining certificates.</p>
<p>You need to create secret files inside the clouds secret folder on your proxmox cluster:</p>
<ul>
<li>for aws route53 create <code>/etc/pve/cloud/secrets/aws-route53-global.json</code>, this should contain read / write access to your route53:</li>
</ul>
<pre><code class="language-json">{
  &quot;AWS_ACCESS_KEY_ID&quot;: &quot;ACCESS_ID_HERE&quot;,
  &quot;AWS_SECRET_ACCESS_KEY&quot;: &quot;SECRET_KEY_HERE&quot;,
  &quot;AWS_REGION&quot;: &quot;REGION&quot;
}
</code></pre>
<ul>
<li>for method <code>ionos</code> create <code>/etc/pve/cloud/secrets/ionos-api-key.json</code>:</li>
</ul>
<pre><code class="language-json">{
  &quot;IONOS_PRAEFIX&quot;: &quot;PRAEFIX_HERE&quot;,
  &quot;IONOS_VERSCHLUESSELUNG&quot;: &quot;SECRET_KEY_HERE&quot;
}
</code></pre>
<p>Afterwards you need to sync those secrets to all hosts in the cloud, you can do that by rerunning the <code>setup_pve_clusters</code> playbook - <code>ansible-playbook -i YOUR-CLOUD-INV.yaml pve.cloud.setup_pve_clusters --tags rsync</code>. This needs to be done only once! There is no support for multiple dns providers / multiple accounts yet.</p>
<p>You are welcome to create and submit a MR with your own roles / logic for other providers!</p>
<h2 id="upgrading-a-cluster">Upgrading a cluster</h2>
<p>Upgrading the cluster is as simple as updating the version tag reference of this collection.</p>
<p>You can skip to the latest patch version, but shouldn't skip minor versions as they are tied to kubespray updates. After updating the cloud collection version in your requirements.yaml, you have to run <code>ansible-galaxy install -r requirements.yaml</code> and <code>pip install -r ~/.ansible/collections/ansible_collections/pve/cloud/meta/ee-requirements.txt</code> again.</p>
<p>Then run the upgrade playbook <code>ansible-playbook -i YOUR-KUBESPRAY-INV.yaml pve.cloud.upgrade_kubespray</code>.</p>
<p>Right now kubespray is tightly coupled with the entire collection, meaning you have to update the collection a minor version, then update all your clusters, then the collection again and so forth. In the future this will be split to make it more versatile. There is a version lock for the collection that will prevent you from doing updates, if you do this in any other order.</p>
<h2 id="custom-kubespray-vars">Custom kubespray vars</h2>
<p>To define your own kubespray vars just create <code>group_vars/all</code> and <code>group_vars/k8s_cluster</code> directories alongside your inventory file.</p>
<p>Here are some interesting kubespray settings you might want to set (k8s_cluster vars):</p>
<ul>
<li>increase amount of schedulable pods per node (if you have big nodes)</li>
</ul>
<pre><code class="language-yaml">kube_network_node_prefix: 22
kubelet_max_pods: 1024
</code></pre>
<ul>
<li>set strict eviction limits, this is a good safe guard for node availability incase you have memory hungry deployments without any requests / limits defined </li>
</ul>
<pre><code class="language-yaml"># this will enable reservations with the default values, see kubespray sample inventory
kube_reserved: true
kube_reserved_cgroups_for_service_slice: kube.slice
kube_reserved_cgroups: &quot;/{{ kube_reserved_cgroups_for_service_slice }}&quot;

system_reserved: true
system_reserved_cgroups_for_service_slice: system.slice
system_reserved_cgroups: &quot;/{{ system_reserved_cgroups_for_service_slice }}&quot;
system_memory_reserved: 1024Mi

eviction_hard:
  memory.available: 1000Mi
</code></pre>
<p>=&gt; this, in addition to the <code>adjust_networkd_oom_score</code> role, will allow k8s nodes to run even if we got memory hungry, ram hogging deployments. eviction hard and reservations alone are not enough, in oom scenarios it will cause the networkd service to stop working.</p>
<h2 id="exposing-k8s-controlplane-api">Exposing K8S Controlplane API</h2>
<p>If you want to expose your kubenetes clusters controlplane to integrate with external running services, you can set additional SANs that will be generated and inserted by kubespray into the kubeapi certificates, by listing them in your kubespray inventory file under <code>extra_control_plane_sans</code> as simple strings.</p>
<p>Adding SANs there will also configure the pve cloud haproxy to route any control plane traffic (6443) on its external ip to respecive cluster.</p>
<p>DNS Records for these SANs have to be created manually (for internal and external DNS servers), for that use terraforms dns, route53 and ionos provider.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["toc.follow", "toc.integrate"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>